<!DOCTYPE html!>
<head>

            <title>Upgrading from SabreDAV 1.8 to 1.9 - sabre/dav</title>
    
    <link rel="stylesheet" type="text/css" href="/css/sabredav.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:100,700,300,400" type="text/css">
    <link rel="stylesheet" href="/components/highlightjs/styles/github.css" type="text/css" />

    <link rel="shortcut icon" href="/favicon.ico" />

</head>
<body>
    <header>

    <div class="logo">
        <a href="/">
            <img src="/img/logo.png" alt="SabreDAV. A WebDAV framework for PHP.">
            SabreDAV wiki
        </a>
    </div>

    <nav>
        <ul>
            <li><a href="/">sabre/dav</a></li>
            <li><a href="/">sabre/event</a></li>
            <li><a href="/">sabre/http</a></li>
            <li><a href="/">sabre/vobject</a></li>
        </ul>
    </nav>

</header>

    <main>
        <aside>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/dav/install">Installation</a></li>
        <li><a href="/dav/upgrading">Upgrading</a></li>
        <li><a href="/dav/gettingstarted">Getting Started</a></li>
        <li>
            Troubleshooting
            <ul>
                <li><a href="/dav/faq">FAQ</a></li>
                <li><a href="/dav/clients">Clients</a></li>
                <li><a href="/dav/webservers">Webservers</a></li>
            </ul>
        </li>
        <li>
            CalDAV
            <ul>
                <li><a href="/dav/caldav">Getting started</a></li>
                <li><a href="/dav/building-a-caldav-client">Building a CalDAV client</a></li>
                <li><a href="/dav/caldav-carddav-integration-guide">Integration guide</a></li>
                <li><a href="/dav/caldav-proxy">Delegation</a></li>
                <li><a href="/dav/caldav-sharing">Calendar sharing</a></li>
                <li><a href="/dav/ics-export-plugin">iCalendar export</a></li>
                <li><a href="/dav/imiphandler">iMip Handler</a></li>
                <li><a href="/dav/service-discovery">Service Discovery</a></li>
            </ul>
        </li>
        <li>
            CardDAV
            <ul>
                <li><a href="/dav/carddav">Getting started</a></li>
                <li><a href="/dav/building-a-carddav-client">Building a CardDAV client</a></li>
                <li><a href="/dav/caldav-carddav-integration-guide">Integration guide</a></li>
                <li><a href="/dav/carddav-directory">CardDAV Directory</a></li>
                <li><a href="/dav/vcf-export-plugin">vCard export</a></li>
                <li><a href="/dav/service-discovery">Service Discovery</a></li>
            </ul>
        </li>
        <li>
            Other topics
            <ul>
                <li><a href="/dav/acl">Acl</a></li>
                <li><a href="/dav/authentication">Authentication</a></li>
                <li><a href="/dav/character-encoding">Character encoding</a></li>
                <li><a href="/dav/browser-plugin">Directory indexes</a></li>
                <li><a href="/dav/davmount">DavMount</a></li>
                <li><a href="/dav/guesscontenttype">Content Types</a></li>
                <li><a href="/dav/http-patch">PATCH support</a></li>
                <li><a href="/dav/large-files">Large files</a></li>
                <li><a href="/license">License</a></li>
                <li><a href="/dav/litmus">Litmus</a></li>
                <li><a href="/dav/plugins">Plugins</a></li>
                <li><a href="/dav/scalability">Scalability</a></li>
                <li><a href="/dav/simplecollection">SimpleCollection</a></li>
                <li><a href="/dav/standards-support">Standards Support</a></li>
                <li><a href="/dav/temporary-files">Temporary Files</a></li>
                <li><a href="/dav/versioning">Versioning</a></li>
                <li><a href="/dav/virtual-filesystems">Virtual filesystems</a></li>
                <li><a href="/dav/davclient">WebDAV Client</a></li>
                <li><a href="/dav/xmlelements">XML Elements</a></li>
                <li><a href="/dav/large-files">Large files</a></li>
                <li><a href="/dav/writing-plugins">Writing Plugins</a></li>
            </ul>
        </li>
    </ul>
</aside>
        <article>
                        <h1>Upgrading from SabreDAV 1.8 to 1.9</h1>            <p>SabreDAV 1.9 is not yet released. A first alpha will be released soon though.</p>

<p>SabreDAV 1.9 breaks backwards compatibility in a number of areas. This
document describes which those are. An attempt has been made to put this in
the order of likelyhood you're running into the issues.</p>

<h2>New stuff</h2>

<ul>
<li>Support for <a href="http://tools.ietf.org/html/rfc6578">WebDAV-Sync (rfc6578)</a>.</li>
<li>Support for managing calendar subscriptions. This is a proprietary extension
that's supported by at least iCal, iOS and BusyCal.</li>
<li>Support for <a href="/dav/jcal">jCal</a>. A CalDAV client can now request to receive
jCal, which is a json-based serialization for iCalendar.</li>
<li>Added: A BasicCallback authentication backend. This authentication backend
uses a callback to verify a username + password, making it extremely easy to
set this up.</li>
<li>Now ships with <a href="https://github.com/fruux/sabre-vobject">sabre/vobject 3</a>.</li>
<li>Gave the 'HTTP' package an overhaul, and moved this into a separate project.
See the <a href="https://github.com/fruux/sabre-http">github project page</a> for more info.</li>
<li>The event/plugin system also spliced off into a separate package.
<a href="https://github.com/fruux/sabre-event">github page</a>.</li>
<li>The <a href="/dav/ics-export-plugin">ICSExportPlugin</a> got a <em>lot</em> of changes that
made it easier for browser-based javascript applications to integrate.</li>
</ul>

<p>To read the full list of changes (there's quite a few!) read the changelogs:</p>

<ul>
<li><a href="https://github.com/fruux/sabre-dav/blob/master/ChangeLog.md">sabre/dav</a></li>
<li><a href="https://github.com/fruux/sabre-vobject/blob/3.1.3/ChangeLog">sabre/vobject</a></li>
<li><a href="https://github.com/fruux/sabre-event/blob/1.0.0/ChangeLog">sabre/event</a></li>
<li><a href="https://github.com/fruux/sabre-http/blob/2.0.1/ChangeLog">sabre/http</a></li>
</ul>

<h2>API Changes and BC breaks</h2>

<h3>Now requires PHP 5.4</h3>

<p>If you are still running PHP 5.3, you must not upgrade SabreDAV. SabreDAV 1.8
will be maintained for bugfixes for some time, but you should consider upgrading
your PHP version to PHP 5.4, to take advantage of the latest and greatest, and
get a big speed-up in the process.</p>

<h3>Database changes for PDO backends</h3>

<p>The PDO backends got a number of changes, mainly to speed things up, but also
to provide support for new features.</p>

<p>This affects you if you were running either a CalDAV or a CardDAV server, with
the default PDO backend.</p>

<p>Before you start the migration process, please make a backup first! No
warranty is given for lost data.</p>

<p>To run the database upgrade, simply start <code>./bin/migrate19.php</code> from the SabreDAV
project. This script will give you more information about it's arguments.</p>

<h3>Taking advantage of WebDAV-sync</h3>

<p>This affects you if you were running a Cal or CardDAV server with the default
PDO backend.</p>

<p>This is an optional step, but after upgrading the database schema, you can
add the following line to your server file to turn on WebDAV-sync:</p>

<pre><code>$server-&gt;addPlugin(new \Sabre\DAV\Sync\Plugin());
</code></pre>

<p>The result is much faster synchronization with modern Cal and CardDAV clients.
For high-load systems, you should see significant improvements in CPU, Memory
and bandwidth usage.</p>

<h3>Upgraded to sabre/vobject 3</h3>

<p>If you've done any work with sabre/vobject, and you should also read the
<a href="https://github.com/fruux/sabre-vobject/blob/master/doc/MigratingFrom2to3.md">migration instructions</a> from the vobject project page.</p>

<p>Since this SabreDAV version we are now shipping sabre/vobject 3, which has a
large amount of improvements over sabre/vobject 2, but also breaks a few
things.</p>

<h3>Event / Plugin system got a massive overhaul</h3>

<p>This affects you if you wrote your own plugins, or if you used
<code>subscribeEvent</code>  or <code>broadcastEvent</code> manually.</p>

<p>SabreDAV now externalized the event system into a separate project, namely
<a href="https://github.com/fruux/sabre-event">sabre/event</a>.</p>

<p>In simple terms this means that:</p>

<ul>
<li><code>Sabre\DAV\Server::broadcastEvent</code> got renamed to <code>::emit</code>.</li>
<li><code>Sabre\DAV\Server::subscribeEvent</code> got renamed to <code>::on</code>.</li>
</ul>

<p>The arguments to these two functions have stayed the same, a bunch more
event-related methods have been added, as documented on the sabre/event project
page.</p>

<p>However, because we had to change this, we also took the chance to change the
arguments of a lot of SabreDAV events, to make them much more effective.</p>

<p>A lot of events had a <code>$method</code> and a <code>$uri</code> argument. I was unhappy with this
design, as for any other information related to the HTTP request, aside from the
method or uri had to be grabbed from <code>$server-&gt;httpRequest</code>.</p>

<p>Similarly, any information sent back to the client always had to be done
through <code>$server-&gt;httpResponse</code>.</p>

<p>Both these properties still exists, but it is not longer the recommended way
to read information about http requests and change the http response. Instead,
event handlers get a full <code>$request</code> and <code>$response</code> objects as their direct
arguments.</p>

<p>This allows for much easier unittesting, as well as event handlers to do
live-rewriting or sub-requests without affecting the global state.</p>

<p>The main events that have changed their behavior are 'beforeMethod' and
'unknownMethod'. 'unknownMethod' has been completely removed, and 'beforeMethod'
has altered.</p>

<p>The implication is that <em>every single plugin</em> that implemented those events
has now also changed. Besides using <code>on</code> instead of <code>subscribeEvent</code>, the
bodies for the event handlers have been changed to use new arguments.</p>

<p>More on the method-handling process in the next chapter.</p>

<h3>Events related to HTTP method handling</h3>

<p>The beforeMethod event has changed quite a bit, and the unknownMethod event
had been completely removed.</p>

<p>When a HTTP method is executed on a SabreDAV server, for example the 'GET'
method, the following events are triggered in order:</p>

<ol>
<li>beforeMethod:GET</li>
<li>beforeMethod</li>
<li>method:GET</li>
<li>method</li>
<li>afterMethod:GET</li>
<li>afterMethod</li>
</ol>

<p>By default the <code>CorePlugin</code> will register an event handler for <code>method:GET</code>.
If you'd like to handle GET in certain cases, you can be first by registering
your own GET method handler, with a lower priority.</p>

<p>The default priority for every method is 100, so by specifying 90 we guarantee
that our event is always triggered first.</p>

<pre><code>use
    Sabre\HTTP\RequestInterface,
    Sabre\HTTP\ResponseInterface;


$myGetHandler = function(RequestInterface $request, ResponseInterface $response) {

    // If the filename contains the word cat, we will return miaow instead of
    // the real response body.
    $path = $request-&gt;getPath();
    if (false === strpos($path, 'cat')) {
        // No cat = do nothing
        return;
    }

    // There was a cat in the url. Lets do weird stuff.
    $response-&gt;setBody('Miaow!');
    $response-&gt;setStatus(200); // 200 OK
    $response-&gt;setHeader('Content-Type', 'text/plain');

    // This ensures that the standard GET handler does not kick in.
    return false;

};

$server-&gt;on('beforeMethod:GET', $myGetHandler, 90);
</code></pre>

<p>Every method-related handlers get 2 arguments, the http request and the
http response.</p>

<p>beforeMethod allows you to prevent a method from being executed. The ACL
method uses this to ensure that methods are not handled if the user did not
have permission to do so.</p>

<p>beforeMethod also allows you to rewrite the response body before it's being
handled, for whatever reason. You may want to convert the format of the
response body to something else.</p>

<p>The <code>method</code> and <code>method:GET</code> events (for the PUT method, it would be
<code>method:PUT</code>) are strictly reserved for actually handling the event. If you did
handle the event, you <em>must</em> return <code>false</code> from your event handler to indicate
that the method is handled, and no other system has to do any handling.</p>

<p>The afterMethod event is to do any post-processing. You could use this to log
that the method has been executed, or re-write the responsebody after it has
been generated.</p>

<h3>CalDAV BackendInterface adds a new method</h3>

<p>This affects you, if you wrote your own CalDAV backend.</p>

<p>The CalDAV BackendInterface now adds the <code>getMultipleCalendarObjects</code> method.
Implementing this can result in significant speed-ups.</p>

<p>If you extended <code>AbstractBackend</code>, there already is a default implementation,
that lazily falls back on calling <code>getCalendarObject</code>.</p>

<h3>CardDAV BackendInterface adds a new method</h3>

<p>This affects you, if you wrote your own CardDAV backend.</p>

<p>The CardDAV BackendInterface now adds the <code>getMultipleCards</code> method.
Implementing this can result in significant speed-ups.</p>

<p>If you extended <code>AbstractBackend</code>, there already is a default implementation,
that lazily falls back on calling <code>getCard</code>.</p>

<h3>CalDAV and CardDAV PDO backends now have support for WebDAV-Sync</h3>

<p>Support for WebDAV-Sync means that every change that's happening in any
calendar or addressbook is now recorded.</p>

<p>This allows a client to simply ask for all modifications since the last sync,
and greatly improves performance on a number of fronts.</p>

<p>If you made custom modifications to the PDO backends, keep in mind that
because of this new functionality, some stuff may not work exactly liked it
used to. If for example the methods that create or modify calendar objects
don't register a change in the database, a client may never see this change.</p>

<p>Similarly, if you made modifications manually in the database, these may also
be 'lost changes'. The best recommendation I can give is to have a good look
at the new PDO backends and see what's going on there.</p>

<h3>Updates in the sabre/http API</h3>

<p>The lib/Sabre/HTTP portion of the library moved to it's own package, and got an
almost 100% rewrite.</p>

<p>If you did anything directly with <code>Sabre\HTTP</code>, it's likely that things have
changed. This is most likely true if you ever created an instance of a class in
the <code>Sabre\HTTP</code> namespace, you did something with Authentication or something
with the <code>Request</code> and <code>Response</code> objects.</p>

<h4>The Request object</h4>

<p>Old syntax:</p>

<pre><code>$request = new \Sabre\HTTP\Request();
</code></pre>

<p>new syntax:</p>

<pre><code>$request = \Sabre\HTTP\Sapi::getRequest();
</code></pre>

<p>If you ever created a 'fake' or 'mock' http request, you probably used a syntax
such as the following:</p>

<pre><code>$request = new \Sabre\HTTP\Request([
    'REQUEST_URI' =&gt; '/foo',
    'REQUEST_METHOD' =&gt; 'POST',
    'HTTP_CONTENT_TYPE' =&gt; 'application/xml',
]);
</code></pre>

<p>The new syntax looks like this:</p>

<pre><code>$request = \Sabre\HTTP\Sapi::createFromServerArray([
    'REQUEST_URI' =&gt; '/foo',
    'REQUEST_METHOD' =&gt; 'POST',
    'HTTP_CONTENT_TYPE' =&gt; 'application/xml',
]);
</code></pre>

<p>But.. this is still a bit ugly, as it requires you to manually re-construct
the cgi variables from <code>$_SERVER</code>. The new, improved syntax looks like this:</p>

<pre><code>$request = new Request(
  'POST',
  '/foo',
  ['Content-Type' =&gt; 'application/xml']
);
</code></pre>

<h4>The Response object</h4>

<p>Before, the response object would automatically call <code>header()</code> and send the
response body as soon as possible.</p>

<p>This is no longer true, and some methods also have changed.</p>

<p>Before you would do something like this:</p>

<pre><code>$response = new \Sabre\HTTP\Response();
$response-&gt;setHeader('Content-Type', 'application/xml'); // This would already call php's header() !
$response-&gt;sendStatus(201); // This also calls php's header()
$response-&gt;sendBody('&lt;?xml version="1.0"?&gt;...etc'); // This calls fpassthru/echo
</code></pre>

<p>The new response object doesn't send anything right away. Everything is
buffered, until sendResponse() is called. In addition, sendStatus is now setStatus,
and sendBody is setBody.</p>

<pre><code>$response = new \Sabre\HTTP\Response();
$response-&gt;setHeader('Content-Type', 'application/xml');
$response-&gt;setStatus(201);
$response-&gt;setBody('&lt;?xml version="1.0"?&gt;...etc');

\Sabre\HTTP\Sapi::sendResponse($response);
</code></pre>

<h4>Authentication</h4>

<p>The authentication-related classes have moved into their own namespace.
The new class names are:</p>

<ul>
<li><code>Sabre\HTTP\AbstractAuth</code> is now <code>Sabre\HTTP\Auth\AbstractAuth</code>.</li>
<li><code>Sabre\HTTP\BasicAuth</code> is now <code>Sabre\HTTP\Auth\Basic</code>.</li>
<li><code>Sabre\HTTP\DigestAuth</code> is now <code>Sabre\HTTP\Auth\Digest</code>.</li>
<li><code>Sabre\HTTP\AWSAuth</code> is now <code>Sabre\HTTP\Auth\AWS</code>.</li>
</ul>

<p>Furthermore, the constructor arugments have changed for all of these. The
following 3 arguments are now required:</p>

<ul>
<li><code>$realm</code></li>
<li><code>$request</code></li>
<li><code>$response</code></li>
</ul>

<p><code>$realm</code> is just a single string. <code>$request</code> must be a Request object, and
<code>$response</code> and instance of Response.</p>

<h3>Custom WebDAV serialization slightly changed</h3>

<p>If you implemented your own custom, complex WebDAV properties, using
<code>Sabre\DAV\Property</code> as a base-class, this affects you.</p>

<p>The <code>unserialize</code> method now got an extra argument. The full signature changed
from <code>static function unserialize(\DOMElement)</code> to
<code>static function unserialize(\DOMElement, array $propertyMap)</code>. The new
<code>$propertyMap</code> argument contains the list of WebDAV properties and which classes
they should be mapped to.</p>

<p>All you likely have to do, is to just add that new argument to the method
declaration, to ensure PHP doesn't emit any warnings.</p>

<h3>Functionality moved from the Server class to CorePlugin</h3>

<p>This version of SabreDAV adds a 'CorePlugin', which uses the plugin system to
provide basic functionality. The plugin is automatically added.</p>

<p>It does mean that a number of functions have moved from Sabre\DAV\Server to
this plugin.</p>

<p>If you sub-classed Sabre\DAV\Server, or called any of these methods manually
for some reason, your code will break.</p>

<p>The relevant methods are :</p>

<ul>
<li><code>httpGet</code></li>
<li><code>httpOptions</code></li>
<li><code>httpHead</code></li>
<li><code>httpDelete</code></li>
<li><code>httpPropfind</code></li>
<li><code>httpPropPatch</code></li>
<li><code>httpPut</code></li>
<li><code>httpMkcol</code></li>
<li><code>httpMove</code></li>
<li><code>httpCopy</code></li>
<li><code>httpReport</code></li>
</ul>

<h3>Removed Version-related constants ===</h3>

<p><code>Sabre\DAV\Version::STABILITY</code> no longer exists. The stability is now
incorporated in the VERSION constant.</p>

<p>Furthermore, the following classes have been removed, as they mostly
contained redundant information:</p>

<ul>
<li><code>Sabre\CalDAV\Version</code></li>
<li><code>Sabre\CardDAV\Version</code></li>
<li><code>Sabre\DAVACL\Version</code></li>
</ul>

<h3>Changed Sabre\DAV\Server::getCopyMoveInfo ===</h3>

<p>This method now requires a <code>RequestInterface</code> object as its first argument.
This object will be used to figure out all the relevant information, rather
than the global SabreDAV state.</p>

<h3>Sabre\DAV\URLUtil has moved</h3>

<p>The new classname for this utility is Sabre\HTTP\URLUtil.</p>

<p>The old class still exists, but will be removed in a future version.</p>
                    </article>
    </main>

    <script src="/components/highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-2848664-5', 'sabredav.org');
ga('send', 'pageview');
</script>

    
</body>
